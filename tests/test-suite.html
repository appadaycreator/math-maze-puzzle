<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Maze Puzzle - テストスイート</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-pending {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .test-stats {
            font-size: 1.2em;
            font-weight: bold;
            margin: 20px 0;
        }
        .test-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-group h3 {
            margin-top: 0;
            color: #333;
        }
        #test-progress {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        #test-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8">Math Maze Puzzle - テストスイート</h1>
        
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">テスト実行状況</h2>
            <div id="test-progress">
                <div id="test-progress-bar"></div>
            </div>
            <div id="test-stats" class="test-stats">
                準備中...
            </div>
            <div class="flex gap-4 mb-4">
                <button id="run-all-tests" class="btn btn-primary">全テスト実行</button>
                <button id="run-unit-tests" class="btn btn-secondary">ユニットテスト実行</button>
                <button id="run-integration-tests" class="btn btn-secondary">統合テスト実行</button>
                <button id="clear-results" class="btn btn-outline">結果クリア</button>
            </div>
        </div>

        <!-- ユニットテスト -->
        <div class="test-group bg-white rounded-lg shadow-md p-6">
            <h3>ユニットテスト</h3>
            <div id="unit-test-results"></div>
        </div>

        <!-- 統合テスト -->
        <div class="test-group bg-white rounded-lg shadow-md p-6">
            <h3>統合テスト</h3>
            <div id="integration-test-results"></div>
        </div>

        <!-- UIテスト -->
        <div class="test-group bg-white rounded-lg shadow-md p-6">
            <h3>UIテスト</h3>
            <div id="ui-test-results"></div>
        </div>

        <!-- パフォーマンステスト -->
        <div class="test-group bg-white rounded-lg shadow-md p-6">
            <h3>パフォーマンステスト</h3>
            <div id="performance-test-results"></div>
        </div>

        <!-- テスト詳細ログ -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h3>詳細ログ</h3>
            <div id="test-log" class="bg-gray-100 p-4 rounded text-sm font-mono" style="height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- テストスクリプト -->
    <script src="../js/main.js"></script>
    <script src="../js/game.js"></script>
    <script src="../js/maze.js"></script>
    <script src="../js/problems.js"></script>
    <script src="../js/ui.js"></script>
    <script src="ui-tests.js"></script>
    <script>
        // テストスイート管理
        class TestSuite {
            constructor() {
                this.tests = [];
                this.results = [];
                this.currentTest = 0;
                this.isRunning = false;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('run-all-tests').addEventListener('click', () => this.runAllTests());
                document.getElementById('run-unit-tests').addEventListener('click', () => this.runTestGroup('unit'));
                document.getElementById('run-integration-tests').addEventListener('click', () => this.runTestGroup('integration'));
                document.getElementById('clear-results').addEventListener('click', () => this.clearResults());
            }

            addTest(name, group, testFn, description = '') {
                this.tests.push({
                    name,
                    group,
                    testFn,
                    description,
                    status: 'pending'
                });
            }

            async runAllTests() {
                if (this.isRunning) return;
                this.isRunning = true;
                this.clearResults();
                this.log('全テストを開始...');

                const startTime = performance.now();
                
                for (let i = 0; i < this.tests.length; i++) {
                    this.currentTest = i;
                    await this.runTest(this.tests[i]);
                    this.updateProgress();
                }

                const endTime = performance.now();
                this.log(`全テスト完了 (${Math.round(endTime - startTime)}ms)`);
                this.updateStats();
                this.isRunning = false;
            }

            async runTestGroup(group) {
                if (this.isRunning) return;
                this.isRunning = true;
                this.clearResults();
                this.log(`${group}テストを開始...`);

                const groupTests = this.tests.filter(test => test.group === group);
                const startTime = performance.now();

                for (let i = 0; i < groupTests.length; i++) {
                    await this.runTest(groupTests[i]);
                }

                const endTime = performance.now();
                this.log(`${group}テスト完了 (${Math.round(endTime - startTime)}ms)`);
                this.updateStats();
                this.isRunning = false;
            }

            async runTest(test) {
                this.log(`実行中: ${test.name}`);
                const startTime = performance.now();
                
                try {
                    await test.testFn();
                    const endTime = performance.now();
                    test.status = 'pass';
                    test.duration = Math.round(endTime - startTime);
                    this.log(`✓ ${test.name} (${test.duration}ms)`);
                    this.addResult(test, 'pass');
                } catch (error) {
                    const endTime = performance.now();
                    test.status = 'fail';
                    test.duration = Math.round(endTime - startTime);
                    test.error = error.message;
                    this.log(`✗ ${test.name} - ${error.message} (${test.duration}ms)`);
                    this.addResult(test, 'fail', error.message);
                }
            }

            addResult(test, status, error = '') {
                const resultElement = document.createElement('div');
                resultElement.className = `test-result test-${status}`;
                resultElement.innerHTML = `
                    <strong>${test.name}</strong> 
                    <span class="text-sm">(${test.duration}ms)</span>
                    ${test.description ? `<br><small>${test.description}</small>` : ''}
                    ${error ? `<br><code>${error}</code>` : ''}
                `;

                const container = document.getElementById(`${test.group}-test-results`);
                if (container) {
                    container.appendChild(resultElement);
                }
                
                this.results.push({ test, status, error });
            }

            updateProgress() {
                const progress = ((this.currentTest + 1) / this.tests.length) * 100;
                document.getElementById('test-progress-bar').style.width = `${progress}%`;
            }

            updateStats() {
                const passed = this.results.filter(r => r.status === 'pass').length;
                const failed = this.results.filter(r => r.status === 'fail').length;
                const total = this.results.length;
                
                document.getElementById('test-stats').innerHTML = `
                    合計: ${total} | 成功: ${passed} | 失敗: ${failed} | 成功率: ${Math.round((passed/total)*100)}%
                `;
            }

            clearResults() {
                this.results = [];
                ['unit', 'integration', 'ui', 'performance'].forEach(group => {
                    const container = document.getElementById(`${group}-test-results`);
                    if (container) {
                        container.innerHTML = '';
                    }
                });
                document.getElementById('test-log').innerHTML = '';
                document.getElementById('test-stats').innerHTML = '準備中...';
                document.getElementById('test-progress-bar').style.width = '0%';
            }

            log(message) {
                const logElement = document.getElementById('test-log');
                const timestamp = new Date().toLocaleTimeString();
                logElement.innerHTML += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
            }
        }

        // テストスイートのインスタンス化
        const testSuite = new TestSuite();

        // テスト定義の読み込み
        if (typeof UITests !== 'undefined') {
            UITests.registerTests(testSuite);
        }

        // 初期化完了のログ
        testSuite.log('テストスイートが初期化されました');
    </script>
</body>
</html> 